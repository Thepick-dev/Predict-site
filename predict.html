<div class="panel" id="knockoutPanel">
  <h1>KNOCKOUT STAGE</h1>
  <div class="sys prominent">SELECT MATCH OUTCOMES: N=Normal Time, ET=Extra Time, P=Penalties</div>
  <div id="knockoutGrid" class="groups-grid"></div>
  <button id="bonusBtn" disabled>SELECT BONUS (COMING SOON)</button>
</div>

<div class="overlay" id="bonusOverlay">
  <div class="modal">
    <h1>BONUS SELECTION</h1>
    <div class="subtitle">This will be implemented soon.</div>
    <button onclick="document.getElementById('bonusOverlay').style.display='none';">CLOSE</button>
  </div>
</div>

<script>
'use strict';

const knockoutGrid = document.getElementById('knockoutGrid');
const bonusBtn = document.getElementById('bonusBtn');
const bonusOverlay = document.getElementById('bonusOverlay');

// Random international teams for L32
const L32_TEAMS = [
  "FRANCE","SPAIN","GERMANY","ITALY",
  "BRAZIL","ARGENTINA","PORTUGAL","ENGLAND",
  "NETHERLANDS","BELGIUM","MEXICO","USA",
  "CANADA","JAPAN","AUSTRALIA","SENEGAL",
  "MOROCCO","SOUTH KOREA","DENMARK","SWITZERLAND",
  "CROATIA","URUGUAY","POLAND","WALLES",
  "COSTA RICA","EGYPT","IRAN","QATAR",
  "NIGERIA","TUNISIA","SAUDI ARABIA","NEW ZEALAND"
];

// State object to track selections
const KO_STATE = {
  L32: Array(16).fill(null),
  L16: Array(8).fill(null),
  QF: Array(4).fill(null)
};

function createMatchEl(team1, team2, stage, index) {
  const div = document.createElement('div');
  div.className = 'group';

  const list = document.createElement('div');
  list.className = 'team-list';

  [team1, team2].forEach((team, i) => {
    const row = document.createElement('div');
    row.className = 'team-row';

    const nameSpan = document.createElement('span');
    nameSpan.className = 'team-name';
    nameSpan.textContent = team;

    ['N','ET','P'].forEach(type => {
      const btn = document.createElement('button');
      btn.className = 'team-btn';
      btn.textContent = type;
      btn.onclick = () => selectOutcome(stage, index, i, type, btn, div);
      row.appendChild(btn);
    });

    row.prepend(nameSpan);
    list.appendChild(row);
  });

  div.appendChild(list);
  return div;
}

function renderL32() {
  knockoutGrid.innerHTML = '';
  for(let i=0;i<16;i++){
    const t1 = L32_TEAMS[i*2];
    const t2 = L32_TEAMS[i*2+1];
    knockoutGrid.appendChild(createMatchEl(t1,t2,'L32',i));
  }
}

function selectOutcome(stage,index,teamIndex,type,btn,matchDiv){
  // Clear previously selected button in this match
  matchDiv.querySelectorAll('.team-btn.selected-2').forEach(b=>b.classList.remove('selected-2'));

  btn.classList.add('selected-2');

  // Record selection in state
  KO_STATE[stage][index] = {teamIndex,type};

  // Populate next stage if applicable
  if(stage==='L32'){
    if(KO_STATE.L32.every(m=>m!==null)) populateNextStage('L16',8,'L32');
  } else if(stage==='L16'){
    if(KO_STATE.L16.every(m=>m!==null)) populateNextStage('QF',4,'L16');
  }

  // Enable bonus button when QF selections complete
  if(stage==='QF' && KO_STATE.QF.every(m=>m!==null)){
    bonusBtn.disabled=false;
  }
}

function populateNextStage(nextStage,numMatches,prevStage){
  // Calculate winners from previous stage
  const winners = KO_STATE[prevStage].map(m=>m.teamIndex===0
    ? L32_TEAMS[prevStage==='L32'? mIndex(prevStage, KO_STATE[prevStage].indexOf(m), 0) : 0]
    : L32_TEAMS[prevStage==='L32'? mIndex(prevStage, KO_STATE[prevStage].indexOf(m),1) : 1]
  );

  // Only append new stage
  for(let i=0;i<numMatches;i++){
    const t1 = winners[i*2];
    const t2 = winners[i*2+1];
    knockoutGrid.appendChild(createMatchEl(t1,t2,nextStage,i));
  }
}

// Utility to find team index for dynamic winner
function mIndex(stage,matchIdx,teamIdx){
  return matchIdx*2+teamIdx;
}

renderL32();

// Bonus popup logic
bonusBtn.onclick=()=>{ bonusOverlay.style.display='flex'; };
</script>
